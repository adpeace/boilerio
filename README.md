# Heating control

The code in this repository implements a basic heating control system that is
able to maintain a set target temperature by modulating a heating zone on/off.

This has been tested with the Danfoss RF transciever code in the thermostat.git
repository at https://github.com/adpeace/thermostat.git.

No warranty is provided: please be careful if you are messing with your own
heating system.

For more information, please see https://hackingathome.wordpress.com.

## boiler\_to\_mqtt.py

The `boiler_to_mqtt.py` script implements an MQTT-topic based interface on top
of the serial protocol provided in the thermostat.git repository.  In short: it
turns the boiler on and off via MQTT.  The serial interface in thermostat.git is
designed to interact with a Danfoss RF thermostat receiver; if you wanted to use
a different receiver you can substitute a different service.

Ordinarily you'd leave this service running so that other services can turn the
boiler on/off as needed.

This service and others in this repository use a common configuration file.  See
below for more information.

## maintaintemp.py

This is the main script and implements a PID controller to maintain a given set
temperature.

Example usage:

```
./maintaintemp.py emon_sensors/emonth5 0xBAB1 19.5
```

The first argument is an MQTT topic from which to get temperature updates.
These updates should have a JSON payload with an object with at least a
`temperature` value.  The temperature updates can be at any frequency, but I've
mostly tested with updates being sent every minute.

The second argument is the thermostat ID to use in messages to the boiler.  For
the Danfoss RF receiver I've been testing with, you will independently need to
send a 'learn' command; this should be transmitted repeatedly (with the correct
thermostat ID) while you hold the 'PROG' and 'CH1/2' button and wait until the
light flashes green on the controller.

You can send learn packets in a loop with a simple shell loop, if you have the
mosquitto clients installed and are running the `boiler_to_mqtt.py` script:

```
echo -n "Learning mode - program boiler then hit enter... "
while ! read -t 1 ; do
    mosquitto_pub -h <host> -u <username> -P <passwd> -t heating/demand \
                  -m '{"command": "L", "thermostat": 47793}'
done
```

The ```heating/deamnd``` topic should match the configuration file you set up -
see below for more information.

The final argument is the target temperature.

For a description of the behaviour of this program, please see the blog entry on
the website mentioned above.

## sim.py

This is a trivial simulator intended to help debug and improve
`maintaintemp.py`.  It follows a really simple heating/cooling model and
generates a table as output.

To run, use a command-line such as:

```
./sim.py -r 18 19.5 600
```

The `-r` option introduces some random noise into the temperature readings
generated by the simulation when passing them to the controller.

The first positional argument is the starting indoor temperature to simulate.
The second argument is the target temperature.  The third argument is
the simulated runtime in minutes.

This program produces logging output to stderr, and a space-separated output to
stdout.  The output is similar to:

```
...
1.0 0 0 17.9964773317 17.9876417779 0 0 0
...
```

The columns are:

1. The time into the simulation, in minutes
2. The amount of time in that minute that the boiler was on for in the
simulation.
3. The current duty cycle of the boiler in the simulation.
4. The current simulated room temperature
5. The fake temperature reading passed to the controller including any error
introduced by the `-r` option.
6. The current value of the proportional term of the PID controller.
7. The current value of the integral term of the PID controller.
8. The current value of the differential term of the PID controller.

You can use the `plot\_sim.gpi` gnuplot script to plot the output of the
simulation.  E.g.:

```
./sim.py -r 18 19.5 600  2>log >sim_data
gnuplot plot_sim.gpi
```

The gnuplot script assumes the simulation output is saved to a file called
`sim\_data`.

# Config file

Other than `sim.py`, a config file is needed for the programs here.  This is to
help make them usable as daemons.

Here is a sample configuration file, to be placed in `/etc/sensors/config`:

```
[mqtt]
host = mqtt.lan
user = user
password = imnottellingyou

[heating]
info_basetopic = heating/zone/info
demand_request_topic = heating/demand
```
